<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TÅ±zijÃ¡tÃ©k â€“ Teljes Rendszer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; padding:20px; }
h1,h2,h3 { color:#facc15; }
.container { max-width:1200px; margin:auto; }
.card { background:#020617; padding:20px; border-radius:12px; margin-bottom:20px; }
table { width:100%; border-collapse:collapse; }
th,td { padding:8px; border-bottom:1px solid #1e293b; text-align:center; }
input,select { padding:6px; border-radius:6px; border:none; }
input { width:110px; }
select { width:55px; }
button { background:#facc15; border:none; padding:6px 12px; border-radius:8px; font-weight:bold; cursor:pointer; }
button:hover { background:#fde047; }
.hidden { display:none; }
</style>
</head>

<body>
<div class="container">
<h1>ğŸ† TÅ±zijÃ¡tÃ©k Ã‰rtÃ©kesÃ­tÃ©si Rendszer</h1>

<div>
<button onclick="showTab('products')">ğŸ“¦ TermÃ©kek</button>
<button onclick="showTab('cart')">ğŸ›’ KosÃ¡r</button>
<button onclick="showTab('history')">ğŸ“œ ElÅ‘zmÃ©nyek</button>
<button onclick="showTab('summary')">ğŸ“Š Napi zÃ¡rÃ¡s</button>
</div>

<div id="products" class="card">
<h2>ğŸ“¦ TermÃ©kek</h2>
<input id="search" placeholder="ğŸ” KeresÃ©s nÃ©v / sorszÃ¡m" oninput="renderProducts()"><br><br>
<table id="productTable"></table><br>
<input id="newSerial" placeholder="SorszÃ¡m">
<input id="newName" placeholder="NÃ©v">
<input id="newStock" type="number" placeholder="KÃ©szlet">
<input id="newPrice" type="number" placeholder="Ãr">
<button onclick="addProduct()">â•</button>
</div>

<div id="cart" class="card hidden">
<h2>ğŸ›’ KosÃ¡r</h2>
<table id="cartTable"></table>
<h3>Ã–sszesen: <span id="total">0</span> Ft</h3>
<button onclick="checkout()">âœ” VÃ¡sÃ¡rlÃ¡s vÃ©glegesÃ­tÃ©se</button>
</div>

<div id="history" class="card hidden">
<h2>ğŸ“œ ElÅ‘zmÃ©nyek</h2>
<table id="historyTable"></table>
</div>

<div id="summary" class="card hidden">
<h2>ğŸ“Š Napi zÃ¡rÃ¡s</h2>
<p>DÃ¡tum: <span id="today"></span></p>
<p>Napi bevÃ©tel: <span id="dailyTotal">0</span> Ft</p>
<table id="stockSummary"></table><br>
<button onclick="endOfDay()">ğŸ›‘ Nap vÃ©ge</button>
</div>

<script>
let products = JSON.parse(localStorage.getItem("products")) || [];
let history = JSON.parse(localStorage.getItem("history")) || [];
let cart = [];
let stockLog = JSON.parse(localStorage.getItem("stockLog")) || [];

function saveAll(){
 localStorage.setItem("products",JSON.stringify(products));
 localStorage.setItem("history",JSON.stringify(history));
 localStorage.setItem("stockLog",JSON.stringify(stockLog));
}

function showTab(id){
 ["products","cart","history","summary"].forEach(t=>document.getElementById(t).classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
 if(id==="history") renderHistory();
 if(id==="summary") renderSummary();
}

function addProduct(){
 if(!newSerial.value||!newName.value) return alert("HiÃ¡nyzÃ³ adat!");
 products.push({
   serial:newSerial.value,
   name:newName.value,
   stock:+newStock.value,
   price:+newPrice.value
 });
 newSerial.value=newName.value=newStock.value=newPrice.value="";
 saveAll(); renderProducts(); renderSummary();
}

function deleteProduct(i){
 if(!confirm("TÃ¶rlÃ¶d a termÃ©ket?")) return;
 products.splice(i,1);
 saveAll(); renderProducts(); renderSummary();
}

function renderProducts(){
 let q=search.value.toLowerCase();
 productTable.innerHTML=
 "<tr><th>SorszÃ¡m</th><th>NÃ©v</th><th>KÃ©szlet</th><th>Ãr</th><th>Menny</th><th>KosÃ¡r</th><th>KÃ©szlet mÃ³dosÃ­tÃ¡s</th><th>Ãr szerkesztÃ©s</th><th></th></tr>";
 products.filter(p=>p.name.toLowerCase().includes(q)||p.serial.toLowerCase().includes(q))
 .forEach((p,i)=>{
   productTable.innerHTML+=`
<tr>
<td>${p.serial}</td>
<td>${p.name}</td>
<td>${p.stock}</td>
<td>${p.price}</td>
<td><input id="q${i}" type="number" min="1"></td>
<td><button onclick="addToCart(${i})">ğŸ›’</button></td>
<td>
  <select id="op${i}">
    <option value="+">+</option>
    <option value="-">-</option>
  </select>
  <input id="chg${i}" type="number" min="1" style="width:70px">
  <button onclick="applyStockChange(${i})">âœ”</button>
</td>
<td>
  <input id="price${i}" type="number" min="0" style="width:80px" placeholder="Ãšj Ã¡r">
  <button onclick="editPrice(${i})">ğŸ’°</button>
</td>
<td><button onclick="deleteProduct(${i})">ğŸ—‘</button></td>
</tr>`; 
 });
}

function editPrice(i){
 let val = parseInt(document.getElementById("price"+i).value);
 if(isNaN(val) || val < 0) return alert("Adj meg Ã©rvÃ©nyes Ã¡rat!");
 products[i].price = val;
 document.getElementById("price"+i).value="";
 saveAll(); renderProducts(); renderSummary();
}

function applyStockChange(i){
 let op = document.getElementById("op"+i).value;
 let val = parseInt(document.getElementById("chg"+i).value);
 if(isNaN(val) || val <= 0) return alert("Adj meg Ã©rvÃ©nyes mennyisÃ©get!");
 let change = op === "+" ? val : -val;
 let newStock = products[i].stock + change;
 if(newStock < 0) return alert("A kÃ©szlet nem lehet negatÃ­v!");
 products[i].stock = newStock;
 stockLog.push({
   date: new Date().toLocaleString(),
   name: products[i].name,
   change: change,
   type: change > 0 ? "PÃ³tlÃ¡s" : "Kivitel"
 });
 document.getElementById("chg"+i).value = "";
 saveAll(); renderProducts(); renderSummary();
}

function addToCart(i){
 let q=+document.getElementById("q"+i).value;
 if(!q||q>products[i].stock) return alert("Nincs ennyi kÃ©szleten");
 cart.push({productIndex:i,name:products[i].name,qty:q,price:products[i].price});
 document.getElementById("q"+i).value="";
 renderCart();
}

function deleteCartItem(i){ cart.splice(i,1); renderCart(); }

function renderCart(){
 let sum=0;
 cartTable.innerHTML="<tr><th>TermÃ©k</th><th>Menny</th><th>Ã–sszeg</th><th></th></tr>";
 cart.forEach((c,i)=>{
   let s=c.qty*c.price; sum+=s;
   cartTable.innerHTML+=
   `<tr><td>${c.name}</td><td>${c.qty}</td><td>${s} Ft</td><td><button onclick="deleteCartItem(${i})">ğŸ—‘</button></td></tr>`;
 });
 total.innerText=sum;
}

function checkout(){
 if(!cart.length) return;
 cart.forEach(c=>products[c.productIndex].stock-=c.qty);
 history.push({date:new Date().toLocaleString(),items:[...cart],total:+total.innerText});
 cart=[]; saveAll();
 renderProducts(); renderCart(); renderHistory(); renderSummary();
 alert("VÃ¡sÃ¡rlÃ¡s rÃ¶gzÃ­tve");
}

function deleteHistory(i){
 if(!confirm("TÃ¶rlÃ¶d az eladÃ¡st?")) return;
 history.splice(i,1); saveAll(); renderHistory(); renderSummary();
}

function renderHistory(){
 historyTable.innerHTML="<tr><th>DÃ¡tum</th><th>TÃ©telek</th><th>Ã–sszeg</th><th></th></tr>";
 history.forEach((h,i)=>{
   historyTable.innerHTML+=
   `<tr><td>${h.date}</td><td>${h.items.map(x=>`${x.name} (${x.qty})`).join(", ")}</td><td>${h.total} Ft</td>
   <td><button onclick="deleteHistory(${i})">ğŸ—‘</button></td></tr>`;
 });
}

function renderSummary(){
 let sold={},sum=0;
 history.forEach(h=>{
   sum+=h.total;
   h.items.forEach(i=>sold[i.name]=(sold[i.name]||0)+i.qty);
 });
 dailyTotal.innerText=sum;
 today.innerText=new Date().toLocaleDateString();
 stockSummary.innerHTML="<tr><th>TermÃ©k</th><th>Eladva</th><th>Maradt</th></tr>";
 products.forEach(p=>{
   stockSummary.innerHTML+=`<tr><td>${p.name}</td><td>${sold[p.name]||0}</td><td>${p.stock}</td></tr>`;
 });
}

function endOfDay(){
 if(!history.length) return alert("Nincs mit lezÃ¡rni!");
 const todayHistory = [...history]; 
 generateDailyPDF(todayHistory);
 history=[]; cart=[]; saveAll();
 renderCart(); renderHistory(); renderSummary();
 alert("Nap lezÃ¡rva, PDF letÃ¶ltve!");
}

function generateDailyPDF(todayHistory){
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF();

 doc.setFontSize(18);
 doc.setTextColor(250,204,21);
 doc.text("NAPI ZÃRÃS JELENTÃ‰S",105,15,null,null,"center");

 const totalRevenue = todayHistory.reduce((a,b)=>a+b.total,0);
 doc.setFontSize(11);
 doc.setTextColor(0);
 doc.text(`DÃ¡tum: ${new Date().toLocaleDateString()}`,14,25);
 doc.text(`Napi bevÃ©tel Ã¶sszesen: ${totalRevenue} Ft`,14,32);

 let y = 40;

 // ===== ELADÃSOK =====
 if(todayHistory.length){
   let rows = [];
   todayHistory.forEach(h=>{
     h.items.forEach(i=>{
       rows.push([h.date,i.name,i.qty,i.qty*i.price]);
     });
   });
   doc.autoTable({
     head:[["IdÅ‘pont","TermÃ©k","MennyisÃ©g","Ã–sszeg"]],
     body:rows,
     startY:y,
     headStyles:{fillColor:[250,204,21],textColor:0},
     alternateRowStyles:{fillColor:[245,245,245],textColor:0},
     theme:'grid'
   });
   y = doc.lastAutoTable.finalY + 10;
 }

 // ===== KÃ‰SZLETMÃ“DOSÃTÃS =====
 const today = new Date().toLocaleDateString();
 const todayStockLog = stockLog.filter(l=>l.date.startsWith(today));
 if(todayStockLog.length){
   let rows = todayStockLog.map(l=>[l.date,l.name,l.type,Math.abs(l.change)]);
   doc.autoTable({
     head:[["IdÅ‘pont","TermÃ©k","TÃ­pus","MennyisÃ©g"]],
     body:rows,
     startY:y,
     headStyles:{fillColor:[250,204,21],textColor:0},
     alternateRowStyles:{fillColor:[245,245,245],textColor:0},
     theme:'grid'
   });
   y = doc.lastAutoTable.finalY + 10;
 }

 // ===== ZÃRÃ“ KÃ‰SZLET =====
 let rows = products.map(p=>{
   const sold = todayHistory.reduce((sum,h)=>{
     const item=h.items.find(it=>it.name===p.name);
     return sum + (item ? item.qty :0);
   },0);
   return [p.name,sold,p.stock];
 });

 doc.autoTable({
   head:[["TermÃ©k","Eladva","Maradt"]],
   body:rows,
   startY:y,
   headStyles:{fillColor:[250,204,21],textColor:0},
   alternateRowStyles:{fillColor:[245,245,245],textColor:0},
   theme:'grid'
 });

 doc.save(`napi_zaras_${new Date().toLocaleDateString().replaceAll('.','_')}.pdf`);
}


renderProducts(); renderHistory(); renderSummary();
</script>
</body>
</html>
